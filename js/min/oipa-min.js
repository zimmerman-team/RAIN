function OipaUrl(e){this.selection=e,this.get_selection_from_url=function(){var e=window.location.search.substring(1);if(""!==e)for(var t=e.split("&"),i=0;i<t.length;i++){var s=t[i].split("="),r=s[1].split(",");this.selection[s[0]]=[];for(var n=0;n<r.length;n++)this.selection[s[0]].push({id:r[n],name:r[n]})}},this.set_current_url=function(){var e=document.URL.toString().split("?")[0]+this.build_parameters();history.pushState&&history.pushState(null,null,e)},this.build_parameters=function(){this.cities=[],this.countries=[],this.regions=[],this.sectors=[],this.budgets=[],this.indicators=[],this.reporting_organisations=[],this.start_actual_years=[],this.start_planned_years=[],this.donors=[],this.query="",this.country="",this.region="",this.group_by="",this.url=null;var e="?p=";return"compare"!=Oipa.pageType?("undefined"!=typeof this.selection.cities&&(e+=this.build_current_url_add_par("cities",this.selection.cities)),"undefined"!=typeof this.selection.countries&&(e+=this.build_current_url_add_par("countries",this.selection.countries)),"undefined"!=typeof this.selection.regions&&(e+=this.build_current_url_add_par("regions",this.selection.regions)),"undefined"!=typeof this.selection.sectors&&(e+=this.build_current_url_add_par("sectors",this.selection.sectors)),"undefined"!=typeof this.selection.budgets&&(e+=this.build_current_url_add_par("budgets",this.selection.budgets)),"undefined"!=typeof this.selection.indicators&&(e+=this.build_current_url_add_par("indicators",this.selection.indicators)),"undefined"!=typeof this.selection.reporting_organisations&&(e+=this.build_current_url_add_par("reporting_organisations",this.selection.reporting_organisations)),"undefined"!=typeof this.selection.donors&&(e+=this.build_current_url_add_par("donors",this.selection.donors)),"undefined"!=typeof this.selection.query&&(e+=this.build_current_url_add_par("query",this.selection.query))):("undefined"!=typeof this.selection.left.cities&&(e+=this.build_current_url_add_par("left_cities",this.selection.left.cities)),"undefined"!=typeof this.selection.left.countries&&(e+=this.build_current_url_add_par("left_countries",this.selection.left.countries)),"undefined"!=typeof this.selection.right.cities&&(e+=this.build_current_url_add_par("right_cities",this.selection.right.cities)),"undefined"!=typeof this.selection.right.countries&&(e+=this.build_current_url_add_par("right_countries",this.selection.right.countries)),"undefined"!=typeof this.selection.indicators&&(e+=this.build_current_url_add_par("indicators",this.selection.indicators))),"?p="===e?"":e=e.replace("?p=&","?")},this.build_current_url_add_par=function(e,t,i){if(void 0===i&&(i=","),0===t.length)return"";for(var s="&"+e+"=",r=0;r<t.length;r++)s+=t[r].id.toString()+i;return s=s.substr(0,s.length-1)}}function OipaSelection(e,t){this.services=[],this.project_types=[],this.themes=[],this.sustainability_types=[],this.cities=[],this.countries=[],this.regions=[],this.sectors=[],this.budgets=[],this.indicators=[],this.reporting_organisations=[],this.start_actual_years=[],this.start_planned_years=[],this.donors=[],this.query="",this.country="",this.region="",this.group_by="",this.url=new OipaUrl(this),1===t&&Oipa.default_organisation_id&&this.reporting_organisations.push({id:Oipa.default_organisation_id,name:Oipa.default_organisation_name})}function OipaIndicatorSelection(e){this.cities=[],this.countries=[],this.regions=[],this.indicators=[],this.url=null,e&&(this.url=new OipaUrl(this))}function OipaList(){this.offset=0,this.limit=10,this.amount=0,this.order_by=null,this.order_asc_desc=null,this.selection=null,this.list_div="#oipa-list",this.pagination_div="#oipa-list-pagination",this.activity_count_div="#project-list-amount",this.init=function(){var e=this;jQuery(this.pagination_div).bootpag({total:5,page:1,maxVisible:6}).on("page",function(t,i){e.go_to_page(i)}),this.update_pagination(),this.load_listeners(),this.extra_init()},this.extra_init=function(){},this.refresh=function(e){if(e)this.update_list(e),this.update_pagination(e),this.load_listeners();else{var t=this.get_url();this.get_data(t)}},this.reset_pars=function(){this.selection.query=null,this.offset=0,this.limit=10,this.amount=0,this.order_by=null,this.order_asc_desc=null,this.refresh()},this.get_url=function(){return search_url+"activity-list/?format=json&limit=10"},this.get_data=function(e){jQuery.support.cors=!0;var t=this;jQuery.ajax({type:"GET",url:e,dataType:"html",success:function(e){t.refresh(e)}})},this.update_list=function(e){jQuery(this.list_div).html(e)},this.load_listeners=function(){},this.update_pagination=function(e){var t=jQuery(this.list_div+" .list-amount-input").val();this.amount=t,$(".current-selection-amount").html(t);var i=Math.ceil(this.amount/this.limit),s=Math.ceil(this.offset/this.limit)+1;jQuery(this.pagination_div).bootpag({total:i})},this.go_to_page=function(e){this.offset=e*this.limit-this.limit,this.refresh()},this.export=function(e){var t=this.get_url();t=t.replace("format=json","format="+e),url_splitted=t.split("?"),t=site_url+ajax_path+"/"+this.api_resource+"/?"+url_splitted[1],jQuery("#ExportListHiddenWrapper").remove(),iframe=document.createElement("a"),iframe.id="ExportListHiddenWrapper",iframe.style.display="none",document.body.appendChild(iframe);var i=base_url+"/"+theme_path+"/export.php?path="+encodeURIComponent(t);jQuery("#ExportListHiddenWrapper").attr("href",i),jQuery("#ExportListHiddenWrapper").attr("target","_blank"),jQuery("#ExportListHiddenWrapper").bind("click",function(){return window.location.href=this.href,!1}),jQuery("#ExportListHiddenWrapper").click(),jQuery("#download-dialog").toggle()}}function OipaMainStats(){this.reporting_organisation=null,this.get_total_projects=function(e,t){if(t)jQuery("#homepage-total-projects").text(t[e]);else{var i=search_url+"activity-aggregate-any/?format=json&group_by=reporting-org",s=this;if(jQuery.support.cors=!0,window.XDomainRequest){var r=new XDomainRequest;r.open("get",i),r.onprogress=function(){},r.ontimeout=function(){},r.onerror=function(){},r.onload=function(){var t=jQuery.parseJSON(r.responseText);(null===t||"undefined"==typeof t)&&(t=jQuery.parseJSON(t.firstChild.textContent)),s.get_total_projects(e,t)},setTimeout(function(){r.send()},0)}else jQuery.ajax({type:"GET",url:i,contentType:"application/json",dataType:"json",success:function(t){s.get_total_projects(e,t)}})}},this.get_total_budget=function(e,t){if(t)jQuery("#homepage-total-budget").text("US$"+comma_formatted(t[e]));else{var i=search_url+"activity-aggregate-any/?format=json&group_by=reporting-org&aggregation_key=total-budget",s=this;if(jQuery.support.cors=!0,window.XDomainRequest){var r=new XDomainRequest;r.open("get",i),r.onprogress=function(){},r.ontimeout=function(){},r.onerror=function(){},r.onload=function(){var t=jQuery.parseJSON(r.responseText);(null===t||"undefined"==typeof t)&&(t=jQuery.parseJSON(t.firstChild.textContent)),s.get_total_budget(e,t)},setTimeout(function(){r.send()},0)}else jQuery.ajax({type:"GET",url:i,contentType:"application/json",dataType:"json",success:function(t){s.get_total_budget(e,t)}})}}}function OipaProject(){this.id="",this.get_url=function(){var e=search_url+"activities/"+this.id+"/?format=json";return e},this.export=function(e){var t=this.get_url();t=t.replace("format=json","format="+e),jQuery("#ExportListHiddenWrapper").remove(),iframe=document.createElement("a"),iframe.id="ExportListHiddenWrapper",iframe.style.display="none",document.body.appendChild(iframe);var i=template_directory+"/export.php?path="+encodeURIComponent(t);jQuery("#ExportListHiddenWrapper").attr("href",i),jQuery("#ExportListHiddenWrapper").attr("target","_blank"),jQuery("#ExportListHiddenWrapper").bind("click",function(){return window.location.href=this.href,!1}),jQuery("#ExportListHiddenWrapper").click(),jQuery("#download-dialog").toggle()}}function OipaProjectList(){this.only_regional=!1,this.only_country=!1,this.get_url=function(){var e=get_activity_based_parameters_from_selection(this.selection);project_path="activities"==Oipa.pageType?"/projects":"/projects-on-detail";var t="",i="";if(1==this.only_country?t="&countries__code__gte=0":1==this.only_regional?t="&regions__code__gte=0":1==this.only_global?t="&activity_scope=1":1==this.only_other&&(t="&regions=None&countries=None&activity_scope=None"),"desc"==this.order_asc_desc&&(i="-"),this.order_by&&(t+="&order_by="+i+this.order_by),"drupal"==Oipa.framework)var s=site_url+ajax_path+project_path+"/?format=json&limit="+this.limit+"&offset="+this.offset+e+t;else if("wordpress"==Oipa.framework){project_path=project_path.substr(1);var s=ajax_path+"?format=json&action="+project_path+"&limit="+this.limit+"&offset="+this.offset+e+t}return s=replaceAll(s," ","%20"),console.log(s),s}}function OipaCountryList(){this.get_url=function(){var e=get_activity_based_parameters_from_selection(this.selection),t="";return this.order_by&&(t+="&order_by="+this.order_by),this.order_asc_desc&&(t+="&order_asc_desc="+this.order_asc_desc),site_url+ajax_path+"/countries/?format=json&limit="+this.limit+"&offset="+this.offset+e+t}}function OipaRegionList(){this.get_url=function(){var e=get_activity_based_parameters_from_selection(this.selection),t="";return this.order_by&&(t+="&order_by="+this.order_by),this.order_asc_desc&&(t+="&order_asc_desc="+this.order_asc_desc),site_url+ajax_path+"/regions/?format=json&limit="+this.limit+"&offset="+this.offset+e+t}}function OipaSectorList(){this.get_url=function(){var e=get_activity_based_parameters_from_selection(this.selection),t="";return this.order_by&&(t+="&order_by="+this.order_by),this.order_asc_desc&&(t+="&order_asc_desc="+this.order_asc_desc),site_url+ajax_path+"/sectors/?format=json&limit="+this.limit+"&offset="+this.offset+e+t}}function OipaDonorList(){this.get_url=function(){var e=get_activity_based_parameters_from_selection(this.selection),t="";return this.order_by&&(t+="&order_by="+this.order_by),this.order_asc_desc&&(t+="&order_asc_desc="+this.order_asc_desc),this.query&&(t+="&query="+this.query),site_url+ajax_path+"/donors/?format=json&limit="+this.limit+"&offset="+this.offset+e+t}}function OipaMap(){this.map=null,this.selection=null,this.slider=null,this.basemap="zimmerman2014.hmpkg505",this.tl=null,this.compare_left_right=null,this.circles={},this.markers=[],this.vistype="circles",this.selected_year=null,"undefined"!=typeof standard_basemap&&(this.basemap=standard_basemap),this.set_map=function(e,t){var i={attributionControl:!1,scrollWheelZoom:!1,zoom:3,minZoom:2,maxZoom:12,continuousWorld:"false"};t&&(i.zoomControl=!1),jQuery("#"+e).css("min-height","200px"),this.map=L.map(e,i).setView([20.505,25.09],3),t&&new L.Control.Zoom({position:t}).addTo(this.map),this.tl=L.tileLayer("https://{s}.tiles.mapbox.com/v3/"+this.basemap+"/{z}/{x}/{y}.png",{maxZoom:12}).addTo(this.map)},this.refresh=function(e){if(e)this.show_data_on_map(e);else if("left"==this.compare_left_right)filter.selection.left.cities.length>0&&this.set_city(filter.selection.left.cities[0].id);else if("right"==this.compare_left_right)filter.selection.right.cities.length>0&&this.set_city(filter.selection.right.cities[0].id);else{var t=this.get_url();this.get_data(t)}},this.get_url=function(){var e=get_activity_based_parameters_from_selection(this.selection),t="activities";return"activity"==this.selection.group_by?t="activities":"country"==this.selection.group_by?t="country-activities":"region"==this.selection.group_by?t="region-activities":"global"==this.selection.group_by&&(t="global-activities"),search_url+t+"/?format=json"+e},this.get_data=function(e){null===e&&this.refresh(1),perform_cors_ajax_call_with_refresh_callback(e,this)},this.delete_markers=function(){for(var e=0;e<this.markers.length;e++)this.map.removeLayer(this.markers[e])},this.show_data_on_map=function(e){if(this.delete_markers(),"activity"==this.selection.group_by);else if("country"==this.selection.group_by||null==this.selection.group_by||""==this.selection.group_by)for(var t=0;t<e.objects.length;t++)null!==e.objects[t].id&&(null!==e.objects[t].latitude||null!==e.objects[t].longitude)&&(curmarker=L.marker([e.objects[t].latitude,e.objects[t].longitude],{icon:L.divIcon({className:"country-marker-icon",html:e.objects[t].total_projects,iconSize:[41,52],iconAnchor:[18,44]})}).bindPopup('<div class="country-marker-popup-header">'+e.objects[t].name+"</div><table><tr><td>YEAR:</td><td>ALL</td></tr><tr><td>PROJECTS:</td><td>"+e.objects[t].total_projects+"</td></tr><tr><td>BUDGET:</td><td>US$"+comma_formatted(e.objects[t].total_budget)+'</td></tr></table><a class="country-marker-popup-zoom" name="'+e.objects[t].id+'" data-country-name="'+e.objects[t].name+'" data-latitude="'+e.objects[t].latitude+'" data-longitude="'+e.objects[t].longitude+'" onclick="map.zoom_on_dom(this);">SHOW PROJECTS IN LIST</a>',{minWidth:300,maxWidth:300,offset:L.point(173,53),closeButton:!1,className:"country-popup"}).addTo(this.map),this.markers.push(curmarker));else if("region"==this.selection.group_by){this.map.setView([10.505,25.09],2);for(var t=0;t<e.objects.length;t++)curmarker=L.marker([e.objects[t].latitude,e.objects[t].longitude],{icon:L.divIcon({className:"global-marker-icon",html:'<div class="region-map-item-wrapper"><div class="region-map-activity-count">'+e.objects[t].total_projects+'</div><div class="region-map-name">'+e.objects[t].name+"</div></div>",iconSize:[150,44],iconAnchor:[18,34]})}).bindPopup('<table><tr><td>YEAR:</td><td>ALL</td></tr><tr><td>PROJECTS:</td><td><a href="'+site_url+"/region/?region_id="+e.objects[t].id+'">'+e.objects[t].total_projects+"</a></td></tr><tr><td>BUDGET:</td><td>US$"+comma_formatted(e.objects[t].total_budget)+"</td></tr></table>",{minWidth:300,maxWidth:300,offset:L.point(215,134),closeButton:!1,className:"region-popup"}).addTo(this.map),this.markers.push(curmarker)}else"global"==this.selection.group_by?(this.map.setView([10.505,25.09],2),curmarker=L.marker([25,-90],{icon:L.divIcon({className:"region-marker-icon",html:'<div class="global-map-item-wrapper"><div class="global-map-activity-count">'+e.objects[0].total_projects+'</div><div class="global-map-name">Global projects</div></div>',iconSize:[150,44],iconAnchor:[18,34]})}).addTo(this.map),this.markers.push(curmarker)):"other"==this.selection.group_by&&(this.map.setView([10.505,25.09],2),curmarker=L.marker([60,-41.31],{icon:L.divIcon({className:"other-projects-marker-icon",html:'<div class="other-projects-map-inner">OTHER PROJECTS<br>US$ </div>',iconSize:[150,44],iconAnchor:[18,34]})}).addTo(this.map),this.markers.push(curmarker));this.load_map_listeners()},this.load_map_listeners=function(){},this.update_indicator_timeline=function(){jQuery(".slider-year").removeClass("slider-active");for(var e=1950;2051>e;e++){var t="y"+e;jQuery.each(indicator_data,function(i,s){return s.years&&t in s.years?(jQuery("#year-"+e).addClass("slider-active"),!1):void 0})}},this.change_basemap=function(e){this.tl._url="https://{s}.tiles.mapbox.com/v3/"+e+"/{z}/{x}/{y}.png",this.tl.redraw()},this.set_city=function(e){var t=new OipaCity;t.id=e;var i=this;return url=search_url+"cities/?format=json&id="+e,jQuery.support.cors=!0,jQuery.ajax({type:"GET",url:url,contentType:"application/json",dataType:"json",success:function(e){t.set_compare_data(e,i.compare_left_right)}}),t},this.zoom_on_dom=function(e){var t=e.getAttribute("name");jQuery("#countries-filters input[type='checkbox']").prop("checked",!1),jQuery("#countries-filters input[value='"+t+"']").prop("checked",!0),filter.save(),$(".btn-list-view").click()}}function OipaCity(){this.id=null,this.name=null,this.latlng=null,this.set_compare_data=function(e,t){this.name=e.objects[0].name,this.latlng=geo_point_to_latlng(e.objects[0].location),"left"==t?(OipaCompare.item1=this,get_wiki_city_data(this.name,"left")):"right"==t&&(OipaCompare.item2=this,get_wiki_city_data(this.name,"right")),OipaCompare.refresh_state++,OipaCompare.refresh_state>1&&(OipaCompare.refresh_state=0,OipaCompare.refresh_comparison())}}function OipaFilters(){this.data=null,this.selection=null,this.firstLoad=!0,this.perspective=null,this.filter_wrapper_div="my-tab-content",this.init=function(){this.update_selection_object();var e=this.get_url();this.get_data(e)},this.save=function(e){if(!e){this.update_selection_object(),this.update_selection_selected();var t=this.validate_selection();if(!t)return!1}return Oipa.refresh_maps(),Oipa.refresh_lists(),Oipa.refresh_visualisations(),Oipa.mainSelection.url.set_current_url(),!0},this.update_selection_selected=function(){var e=this,t="",i=0;for(var s in this.selection.countries)i=1,t+=this.create_selected_button("countries",this.selection.countries[s]);for(var s in this.selection.services)i=1,t+=this.create_selected_button("services",this.selection.services[s]);for(var s in this.selection.project_types)i=1,t+=this.create_selected_button("project_types",this.selection.project_types[s]);for(var s in this.selection.themes)i=1,t+=this.create_selected_button("themes",this.selection.themes[s]);for(var s in this.selection.sustainability_types)i=1,t+=this.create_selected_button("sustainability_types",this.selection.sustainability_types[s]);jQuery(".filter-selection-wrapper").html(t),jQuery(".btn-filter-selected").click(function(t){for(var i=jQuery(this).data("object-id"),s=jQuery(this).data("filter-name"),r=0;r<e.selection[s].length;r++)e.selection[s][r].id==i&&(console.log('input[name="'+e.selection[s][r].name+'"]'),jQuery('input[name="'+e.selection[s][r].name+'"]').attr("checked",!1),e.save())}),i?$("#selection-wrapper").slideDown():$("#selection-wrapper").slideUp()},this.create_selected_button=function(e,t){return'<button type="button" class="btn btn-default btn-filter-selected" data-object-id="'+t.id+'" data-filter-name="'+e+'">'+t.name+" <span>&nbsp;X</span></button>"},this.validate_selection=function(){return!0},this.update_selection_object=function(){this.selection.sectors=this.get_checked_by_filter("sectors"),this.selection.countries=this.get_checked_by_filter("countries"),this.selection.services=this.get_checked_by_filter("services"),this.selection.project_types=this.get_checked_by_filter("project-types"),this.selection.themes=this.get_checked_by_filter("themes"),this.selection.sustainability_types=this.get_checked_by_filter("sustainability-types"),this.selection.budgets=this.get_checked_by_filter("budgets"),this.selection.regions=this.get_checked_by_filter("regions"),this.selection.indicators=this.get_checked_by_filter("indicators"),this.selection.cities=this.get_checked_by_filter("cities"),this.selection.start_planned_years=this.get_checked_by_filter("start_planned_years"),this.selection.donors=this.get_checked_by_filter("donors"),Oipa.default_organisation_id||(this.selection.reporting_organisations=this.get_checked_by_filter("reporting_organisations"))},this.get_selection_object=function(){var e=new OipaSelection;return e.sectors=this.get_checked_by_filter("sectors"),e.countries=this.get_checked_by_filter("countries"),e.budgets=this.get_checked_by_filter("budgets"),e.regions=this.get_checked_by_filter("regions"),e.indicators=this.get_checked_by_filter("indicators"),e.cities=this.get_checked_by_filter("cities"),e.start_planned_years=this.get_checked_by_filter("start_planned_years"),e.donors=this.get_checked_by_filter("donors"),Oipa.default_organisation_id||(e.reporting_organisations=this.get_checked_by_filter("reporting_organisations")),e},this.get_checked_by_filter=function(e){var t=[];return"indicators"===e?(jQuery("#"+e+"-filters input:checked").each(function(e,i){var s=jQuery(this).attr("selection_type");void 0===s&&(s=null),t.push({id:i.value,name:i.name,type:s})}),t):(jQuery("#"+e+"-filters input:checked").each(function(e,i){t.push({id:i.value,name:i.name})}),t)},this.get_url=function(e,t){},this.get_data=function(e){var t=this;if(jQuery.support.cors=!0,window.XDomainRequest){var i=new XDomainRequest;i.open("get",e),i.onprogress=function(){},i.ontimeout=function(){},i.onerror=function(){},i.onload=function(){var e=jQuery.parseJSON(i.responseText);(null===e||"undefined"==typeof e)&&(e=jQuery.parseJSON(e.firstChild.textContent)),t.process_filter_options(e),t.data=e},setTimeout(function(){i.send()},0)}else jQuery.ajax({type:"GET",url:e,contentType:"application/json",dataType:"json",success:function(e){t.process_filter_options(e),t.data=e}})},this.process_filter_options=function(e){var t=4,i=this,s=new Object,r=new Object,n=new Object,o=new Object;for(var a in e.sectors)a>199&&210>a?s[a]=e.sectors[a]:a>209&&220>a?r[a]=e.sectors[a]:a>219&&230>a?n[a]=e.sectors[a]:a>229&&240>a&&(o[a]=e.sectors[a]);i.create_filter_attributes(e.countries,t,"countries"),i.create_filter_attributes(s,t,"services"),i.create_filter_attributes(r,t,"project-types"),i.create_filter_attributes(n,t,"themes"),i.create_filter_attributes(o,t,"sustainability-types");var c=this.get_budget_filter_options();this.initialize_filters()},this.get_budget_filter_options=function(){var e=[];return e.push(["0-20000",{name:"&lt;US$20K"}]),e.push(["20000-100000",{name:"US$20K-US$100K"}]),e.push(["100000-1000000",{name:"US$100K-US$1M"}]),e.push(["1000000-5000000",{name:"US$1M-US$5M"}]),e.push(["5000000",{name:">US$5M"}]),e},this.initialize_filters=function(e){if(!e)var e=this.selection;jQuery("#map-filter-overlay input:checked").prop("checked",!1),"undefined"!=typeof e.sectors&&this.init_filters_loop(e.sectors),"undefined"!=typeof e.countries&&this.init_filters_loop(e.countries),"undefined"!=typeof e.budgets&&this.init_filters_loop(e.budgets),"undefined"!=typeof e.regions&&this.init_filters_loop(e.regions),"undefined"!=typeof e.indicators&&this.init_filters_loop(e.indicators),"undefined"!=typeof e.cities&&this.init_filters_loop(e.cities),"undefined"!=typeof e.reporting_organisations&&this.init_filters_loop(e.reporting_organisations)},this.init_filters_loop=function(e){for(var t=0;t<e.length;t++)jQuery(":checkbox[value="+e[t].id+"]").prop("checked",!0)},this.create_filter_attributes=function(e,t,i,s){var r="",n=6,o=[];if(s)o=e;else{for(var a in e)o.push([a,e[a]]);o.sort(function(e,t){var i=e[1].name.toString().toLowerCase(),s=t[1].name.toString().toLowerCase();return s>i?-1:i>s?1:0})}var c=1;r+='<div class="row '+i+'-filter-page filter-page filter-page-1">';for(var l=0;l<o.length;l++){l%n==0&&(r+=2==t?'<div class="col-md-6 col-sm-6 col-xs-12">':'<div class="col-md-3 col-sm-3 col-xs-6">');var _=o[l][1].name;4==t&&_.length>32?_=_.substr(0,28)+"...":3==t&&_.length>40&&(_=_.substr(0,36)+"..."),r+='<div class="checkbox"><label>',r+='<input type="checkbox" value="'+o[l][0]+'" id="'+o[l][1].name.toString().replace(/ /g,"").replace(",","").replace("&","").replace("%","perc")+'" name="'+o[l][1].name+'" />'+_,r+="</label></div>",l%n==n-1&&(r+="</div>"),l+1>c*n*t-1&&(r+="</div>",c+=1,r+='<div class="row '+i+"-filter-page filter-page filter-page-"+c+'">')}c>1&&(r+="</div>"),this.paginate(1,c,"#"+i+"-pagination",i),jQuery("#"+i+"-filters").html(r),jQuery("."+i+"-filter-page.filter-page-1").show(),this.update_selection_after_filter_load()},this.update_selection_after_filter_load=function(){},this.paginate=function(e,t){var i=2,s="";s+=1==e?'<a href="#" class="pagination-btn-previous btn-prev"></a>':'<a href="#" class="pagination-btn-previous btn-prev">&lt; previous</a>',s+="<ul>",e>1+i&&(s+="<li><a href='#'>1</a></li>"),e>2+i&&(s+="<li>...</li>");for(var r=e-i;e+i+1>r;r++)r>0&&t>=r&&(s+=r==e?"<li class='active'><a>"+r+"</a></li>":"<li><a href='#'>"+r+"</a></li>");return t-(1+i)>e&&(s+="<li>...</li>"),t-i>e&&(s+="<li><a href='#' class='page'><span>"+t+"</span></a></li>"),s+="</ul>",s+=e!=t?'<a href="#" class="pagination-btn-next btn-next">next &gt;</a>':'<a href="#" class="pagination-btn-next btn-next"></a>'},this.load_paginate_listeners=function(e,t){jQuery("#"+e+"-pagination ul a").click(function(i){i.preventDefault();var s=jQuery(this).text();jQuery("#"+e+"-pagination").html(filter.paginate(s,t)),filter.load_paginate_page(e,s),filter.load_paginate_listeners(e,t)}),jQuery("#"+e+"-pagination .pagination-btn-next").click(function(i){i.preventDefault();var s=jQuery("#"+e+"-pagination .active a").text();s=parseInt(s)+1,jQuery("#"+e+"-pagination").html(filter.paginate(s,t)),filter.load_paginate_page(e,s),filter.load_paginate_listeners(e,t)}),jQuery("#"+e+"-pagination .pagination-btn-previous").click(function(i){i.preventDefault();var s=jQuery("#"+e+"-pagination .active a").text();s=parseInt(s)-1,jQuery("#"+e+"-pagination").html(filter.paginate(s,t)),filter.load_paginate_page(e,s),filter.load_paginate_listeners(e,t)})},this.load_paginate_page=function(e,t){jQuery("#"+e+"-filters .filter-page").hide(),jQuery("#"+e+"-filters .filter-page-"+t).show()},this.reload_specific_filter=function(e,t){if(t)columns=4,"left-cities"===e&&this.create_filter_attributes(t.cities,columns,"left-cities"),"right-cities"===e&&this.create_filter_attributes(t.cities,columns,"right-cities"),"indicators"===e&&"compare"==Oipa.pageType&&(this.create_filter_attributes(t.countries,columns,"left-countries"),this.create_filter_attributes(t.countries,columns,"right-countries"),this.create_filter_attributes(t.cities,columns,"left-cities"),this.create_filter_attributes(t.cities,columns,"left-cities")),"regions"===e&&this.create_filter_attributes(t.regions,2,"regions"),"countries"===e&&this.create_filter_attributes(t.countries,columns,"countries"),"cities"===e&&this.create_filter_attributes(t.cities,columns,"cities"),"indicators"===e&&"indicators"==Oipa.pageType&&this.create_filter_attributes(t.indicators,2,"indicators"),this.initialize_filters(selection);else{if(filters=this,selection=this.get_selection_object(),"left-cities"===e)var i=this.get_url(null,"&indicators__in="+get_parameters_from_selection(selection.indicators)+"&countries__in="+get_parameters_from_selection(selection.left.countries));if("right-cities"===e)var i=this.get_url(null,"&indicators__in="+get_parameters_from_selection(selection.indicators)+"&countries__in="+get_parameters_from_selection(selection.right.countries));if("indicators"===e)var i=this.get_url(null,"&regions__in="+get_parameters_from_selection(selection.regions)+"&countries__in="+get_parameters_from_selection(selection.countries)+"&cities__in="+get_parameters_from_selection(selection.cities));if("regions"===e)var i=this.get_url(null,"&indicators__in="+get_parameters_from_selection(selection.indicators));if("countries"===e)var i=this.get_url(null,"&indicators__in="+get_parameters_from_selection(selection.indicators)+"&regions__in="+get_parameters_from_selection(selection.regions));if("cities"===e)var i=this.get_url(null,"&indicators__in="+get_parameters_from_selection(selection.indicators)+"&regions__in="+get_parameters_from_selection(selection.regions)+"&countries__in="+get_parameters_from_selection(selection.countries));if(jQuery.support.cors=!0,window.XDomainRequest){var s=new XDomainRequest;s.open("get",i),s.onprogress=function(){},s.ontimeout=function(){},s.onerror=function(){},s.onload=function(){var t=jQuery.parseJSON(s.responseText);(null===t||"undefined"==typeof t)&&(t=jQuery.parseJSON(t.firstChild.textContent)),filters.reload_specific_filter(e,t)},setTimeout(function(){s.send()},0)}else jQuery.ajax({type:"GET",url:i,contentType:"application/json",dataType:"json",success:function(t){filters.reload_specific_filter(e,t)}})}},this.reset_filters=function(){jQuery("#"+this.filter_wrapper_div+" input[type=checkbox]").attr("checked",!1),filter.selection.search="",filter.selection.query="",filter.selection.country="",filter.selection.region="",filter.selection.services="",filter.selection.project_types="",filter.selection.themes="",filter.selection.sustainability_types="",filter.save()}}function OipaProjectFilters(){function e(e,t){var i="",s=20,r=[];for(var n in e)null===e[n].name&&(e[n].name="Unknown"),r.push([n,e[n]]);r.sort(function(e,t){var i=e[1].name.toString().toLowerCase(),s=t[1].name.toString().toLowerCase();return s>i?-1:i>s?1:0});var o=1;i+='<div class="filter-page filter-page-1">';for(var a=0;a<r.length;a++){a%s==0&&(i+='<div class="span'+12/t+'">');var c=r[a][1].name;4===t&&c.length>32?c=c.substr(0,28)+"...":3===t&&c.length>46&&(c=c.substr(0,42)+"...");var l=r[a][1].total.toString();i+='<div class="squaredThree"><div>',i+='<input type="checkbox" value="'+r[a][0]+'" id="'+r[a][0]+r[a][1].name.toString().replace(/ /g,"").replace(",","").replace("&","").replace("%","perc")+'" name="'+r[a][1].name+'" />',i+='<label class="map-filter-cb-value" for="'+r[a][0]+r[a][1].name.toString().replace(/ /g,"").replace(",","").replace("&","").replace("%","perc")+'"></label>',i+='</div><div class="squaredThree-fname"><span>'+c+" ("+l+")</span></div></div>",a%s===s-1&&(i+="</div>"),a+1>o*s*t-1&&(i+="</div>",o+=1,i+='<div class="filter-page filter-page-'+o+'">')}return i+='<div class="filter-total-pages" name="'+o+'"></div>',o>1&&(i+="</div>"),i}this.get_url=function(e,t){var i=get_activity_based_parameters_from_selection(this.selection),s="";null!==this.perspective&&(s="&perspective="+this.perspective);var r=search_url+"activity-filter-options/?format=json"+s+i;return r}}function OipaExport(e,t){function i(){}this.visualisation=e,this.filetype=t}function OipaEmbed(e){this.visualisation=e}function geo_point_to_latlng(e){return e=e.replace("POINT (",""),e=e.substring(0,e.length-1),lnglat=e.split(" "),latlng=[lnglat[1],lnglat[0]]}function get_parameters_from_selection(e){dlmtr=",";var t="";if(e.length>0){for(var i=0;i<e.length;i++)t+=e[i].id+dlmtr;t=t.substring(0,t.length-1)}return t}function make_parameter_string_from_budget_selection(e){var t="",i="",s="";if(e.length>0){t="99999999999",i="0";for(var r=0;r<e.length;r++)curid=e[r].id,lower_higher=curid.split("-"),lower_higher[0]<t&&(t=lower_higher[0]),lower_higher.length>1&&lower_higher[1]>i&&(i=lower_higher[1])}return""!=t&&"99999999999"!=t&&(s+="&total_budget__gt="+t),""!=i&&"0"!=i&&(s+="&total_budget__lt="+i),s}function get_indicator_parameters_from_selection(e){dlmtr=",";var t="",i="&selection_type__in=";if(e.length>0){for(var s=0;s<e.length;s++)t+=e[s].id+dlmtr,e[s].selection_type&&(i+=e[s].selection_type+dlmtr);t=t.substring(0,t.length-1)}return t+i}function make_parameter_string_from_selection(e,t){var i=get_parameters_from_selection(e);return""!==i?"&"+t+"="+i:""}function make_parameter_string_from_query_selection(e,t){if(""!=e)var e="&"+t+"="+e;else var e="";return e}function get_activity_based_parameters_from_selection(e){var t=make_parameter_string_from_selection(e.regions,"regions__in"),i=make_parameter_string_from_selection(e.countries,"countries__in"),s=make_parameter_string_from_selection(e.sectors,"sectors__in"),r=get_parameters_from_selection(e.services),n=get_parameters_from_selection(e.project_types),o=get_parameters_from_selection(e.themes),a=get_parameters_from_selection(e.sustainability_types),s="&sectors__in=";""!=r&&(s+=r),""!=n&&("&sectors__in="!=s&&(s+=","),s+=n),""!=o&&("&sectors__in="!=s&&(s+=","),s+=o),""!=a&&("&sectors__in="!=s&&(s+=","),s+=a),"&sectors__in="==s&&("&sectors__in="!=s&&(s+=","),s="");var c=make_parameter_string_from_budget_selection(e.budgets),l=make_parameter_string_from_selection(e.start_planned_years,"start_planned__in"),_=make_parameter_string_from_selection(e.donors,"participating_organisations__in"),u=make_parameter_string_from_selection(e.reporting_organisations,"reporting_organisation__in"),p=make_parameter_string_from_query_selection(e.query,"query"),h=make_parameter_string_from_query_selection(e.country,"country"),d=make_parameter_string_from_query_selection(e.region,"region");return t+i+s+c+l+_+u+p+h+d}function comma_formatted(e){return e?e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."):"-"}function replaceAll(e,t,i,s){var r="";r=1===s?"g":"gi";var n=new RegExp(t,r);return ns=e.replace(n,i)}function perform_cors_ajax_call_with_refresh_callback(e,t){if(jQuery.support.cors=!0,window.XDomainRequest){var i=new XDomainRequest;i.open("get",e),i.onprogress=function(){},i.ontimeout=function(){},i.onerror=function(){},i.onload=function(){var e=jQuery.parseJSON(i.responseText);(null===e||"undefined"==typeof e)&&(e=jQuery.parseJSON(e.firstChild.textContent)),t.refresh(e)
},setTimeout(function(){i.send()},0)}else jQuery.ajax({type:"GET",url:e,contentType:"application/json",dataType:"json",success:function(e){t.refresh(e)}})}var Oipa={framework:"drupal",default_organisation_id:null,default_organisation_name:null,pageType:null,mainSelection:new OipaSelection(1),maps:[],refresh_maps:function(){for(var e=0;e<this.maps.length;e++)this.maps[e].refresh()},visualisations:[],refresh_visualisations:function(){this.visualisations=[],jQuery("#visualisation-block-wrapper").empty(),Oipa.create_visualisations()},create_visualisations:function(){var e=this;data=this.mainSelection.indicators,"indicators"==this.pageType&&jQuery.each(data,function(t,i){var s=new OipaLineChart;s.selection=new OipaIndicatorSelection,s.selection.cities=e.mainSelection.cities,s.selection.countries=e.mainSelection.countries,s.selection.regions=e.mainSelection.regions,s.selection.indicators.push({id:i.id,name:i.name,type:i.type}),s.indicator=i.id,s.name=i.name,s.y_name=i.name,s.y_format=d3.format(",r"),s.x_name="Time (Years)",s.x_format=d3.format("r"),s.init(),e.visualisations.push(s)}),"compare"==this.pageType&&OipaCompare.create_visualisations()},lists:[],refresh_lists:function(){for(var e=0;e<this.lists.length;e++)this.lists[e].refresh()}};OipaProjectList.prototype=new OipaList,OipaCountryList.prototype=new OipaList,OipaRegionList.prototype=new OipaList,OipaSectorList.prototype=new OipaList,OipaDonorList.prototype=new OipaList,OipaProjectFilters.prototype=new OipaFilters;var OipaSelectionBox={fill_selection_box:function(){var e="",t="";"undefined"!=typeof current_selection.sectors&&current_selection.sectors.length>0&&(e+=fill_selection_box_single_filter("SECTORS",current_selection.sectors)),"undefined"!=typeof current_selection.countries&&current_selection.countries.length>0&&(e+=fill_selection_box_single_filter("COUNTRIES",current_selection.countries)),"undefined"!=typeof current_selection.budgets&&current_selection.budgets.length>0&&(e+=fill_selection_box_single_filter("BUDGETS",current_selection.budgets)),"undefined"!=typeof current_selection.regions&&current_selection.regions.length>0&&(e+=fill_selection_box_single_filter("REGIONS",current_selection.regions)),"undefined"!=typeof current_selection.cities&&current_selection.cities.length>0&&(e+=fill_selection_box_single_filter("CITIES",current_selection.cities)),"undefined"!=typeof current_selection.indicators&&current_selection.indicators.length>0&&(t=fill_selection_box_single_filter("INDICATORS",current_selection.indicators)),"undefined"!=typeof current_selection.reporting_organisations&&current_selection.reporting_organisations.length>0&&(t=fill_selection_box_single_filter("REPORTING_ORGANISATIONS",current_selection.reporting_organisations)),"undefined"!=typeof current_selection.query&&current_selection.query.length>0&&(e+=fill_selection_box_single_filter("QUERY",current_selection.query)),jQuery("#selection-box").html(e),jQuery("#selection-box-indicators").html(t),this.init_remove_filters_from_selection_box()},fill_selection_box_single_filter:function(e,t){var i='<div class="select-box" id="selected-'+e.toLowerCase()+'">';i+='<div class="select-box-header">',"INDICATORS"===e&&"cpi"===selected_type&&(e="DIMENSIONS"),"QUERY"===e&&(e="SEARCH"),"REPORTING_ORGANISATIONS"===e&&(e="REPORTING ORGANISATIONS"),i+=e,i+="</div>";for(var s=0;s<t.length;s++)i+='<div class="select-box-selected">',i+='<div id="selected-'+t[s].id.toString().replace(/ /g,"").replace(",","").replace("&","").replace("%","perc")+'" class="selected-remove-button"></div>',"unknown"==t[s].name.toString()&&(t[s].name=jQuery(":checkbox[value="+t[s].id+"]").attr("name")),i+="<div>"+t[s].name+"</div>",("INDICATORS"==e||"DIMENSIONS"==e)&&(i+='<div class="selected-indicator-color-filler"></div><div class="selected-indicator'+(s+1).toString()+'-color"></div>'),i+="</div>";return i+="</div>"},init_remove_filters_from_selection_box:function(){jQuery(".selected-remove-button").click(function(){var e=jQuery(this).attr("id");e=e.replace("selected-","");var t=jQuery(this).parent().parent().attr("id");t=t.replace("selected-","");for(var i=current_selection[t],s=0;s<i.length;s++)if(i[s].id===e){jQuery('input[name="'+i[s].name+'"]').attr("checked",!1);break}this.save_selection()})}};